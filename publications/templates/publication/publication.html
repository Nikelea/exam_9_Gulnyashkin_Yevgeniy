{% extends 'base.html' %}
{% load static %}
{% block title %}Publications{% endblock %}
{% load crispy_forms_filters %}
{% block content %}
<h1> {{ publication.user }}'s publication
  {% if request.user == publication.user or request.user.is_superuser %}
  <a href="{% url 'publications:publication_edit' publication.pk %}"><img style="margin-left: 100px;"
      src="{% static 'img/icon/pensil.png' %}" width="30" height="30" alt="Edit"></a>
  {% endif %}
  <br>
  <div class="card" style="width: 40rem;">
    <img class="card-img-top" src="{{ publication.image.url }}" alt="Card image cap">
    <div class="card-body">
      <p class="card-title">
        {% if user.is_authenticated %}
        <a href="" name="like-btn" id="{{publication.id}}" class="btn btn-primary like-btn">
          {% if request.user in publication.likes.all %}
          Из избранного
          {% else %}
          В избранное
          {% endif %}
          {% endif %}
        </a>
        </form>
        {% if request.user == publication.user or request.user.is_superuser %}
        <a data-toggle="modal" data-target="#exampleModal"
          href="{% url 'publications:delete' publication.pk %}">&ensp;Удалить фото</a>
        {% include 'publication/pub_modal.html' with object_to_delete=publication%}
        {% endif %}
        &nbsp;
        <b id="b{{publication.id}}"> | &nbsp; {{ publication.likes.all.count }} people liked this &nbsp; | &nbsp;
          {{ publication.comments_counter }} сomments </b>
      <p class="card-text">{{ publication }}</p>

      <a href="{% url 'publications:index' %}" class="btn btn-primary">Back to the list</a>
    </div>
  </div>
  <br>
  {% for comment in comments %}
  <p>Сообщение: {{comment.text}}</p>
  <p>Автор: {{comment.author}}</p>
  {% endfor %}
  <form action="" method="get" class="mt-2">
    {% csrf_token %}
    <label> Добавить сообщение:</label>
    <input type="text" name="message" placeholder="Введите сообщение" class="form-control" required id="id_message">
    <input type="hidden" value="{{publication.pk}}" id="publication.pk">
    <button type="submit" id="message" class="genric-btn primary circle mt-2">Отправить
    </button>
  </form>
  <script>
    const comment_it = function () {
       let text = document.getElementById('id_message')
       let pub = document.getElementById('publication.pk')

       $.ajax({
           url: `http://localhost:8000/api/v2/comment_it/${pub.value}`,
           method: 'get',
           data: JSON.stringify({ text: text.value}),
           dataType: 'json',
           headers: { 'Authorization': 'Token ' + localStorage.getItem('apiToken') },
           contentType: 'application/json',
           success: window.location.reload(),
           error: function (response, status) { console.log(response); }
       });
   }
   let mes = document.getElementById('message')
   let send = mes.addEventListener('click', comment_it)
</script>
  {% endblock %}